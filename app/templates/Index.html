<!DOCTYPE html>
<html>
    <head>
        <title>
            {{ Title }}
        </title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
        <script src="/static/js/script.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    </head>
    <body>
        <div id="header">
            <h1>Dublin Bikes</h1>
        </div>

        <div id="map">
         
        </div>
        
        <!-- Parent Information Div -->
        <div id="information">

            <!-- Div for dropdown menu -->
            <div id ="drop">
                <select id="stations" name="Select Station"></select>
            </div>

            <div id="dropStationInfo">
            </div>

            <div id="nearestInfo">

            </div>

            <!-- Div showing weather data -->
            <div id="weatherInfo">
                <canvas id="icon1" width="128" height="128"></canvas>
            </div>
        </div>
        
        <div id="dataAnalytics">
            <div id="chart_div" class="chart"></div>
            <div id="hourly_div" class="chart"></div>
        </div>

<!--------------------------Google Map------------------------------------------->
        <script>
            // var coordArray = [];
            // function success(pos) {
            //     lat = pos.coords.latitude;
            //     long = pos.coords.longitude;
            // }
            // navigator.geolocation.getCurrentPosition(success); 
        var map;
       

        function initMap() {
            var options = {
                zoom: 13,
                center: {
                    lat: 53.347432,
                    lng: -6.269827
                }
            }

            var xmlhttp = new XMLHttpRequest();
            var url = "/occupancy";
            var latitudeArray = [];
            var longitudeArray = [];
            var nameArray = [];
            var numberArray = [];
            var bankingArray = [];
            var totalStandsArray = [];
            var availableBikesArray = [];


            xmlhttp.onreadystatechange = function () {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    data = JSON.parse(xmlhttp.response);
<<<<<<< HEAD
                    console.log(data)
                    console.log(data.length)
                    // console.log(data)
                    for (var j = 0; j < data.length; j++) {
                        latitudeArray.push(data[j].latitude)
                        longitudeArray.push(data[j].longitude)
                        nameArray.push(data[j].name)
                        numberArray.push(data[j].number)
                        bankingArray.push(data[j].banking)
                        totalStandsArray.push(data[j].total_stands)
                        availableBikesArray.push(data[j].available_bikes)


                        var marker = new google.maps.Marker({
                            position: {
                                lat: latitudeArray[j],
                                lng: longitudeArray[j]
                            },
                            map: map,
                            title: nameArray[j],
                            station_number: numberArray[j],
                            banking_marker: bankingArray[j],
                            available: (availableBikesArray[j]/totalStandsArray[j]),
                           // icon: 'http://maps.google.com/mapfiles/kml/pal4/icon49.png'
                        })
                        
                        if (marker.available >= 0.25) {
                            marker.setIcon('http://maps.google.com/mapfiles/ms/micons/green-dot.png');
                            }
                        else if ( marker.available > 0) {
                            marker.setIcon('http://maps.google.com/mapfiles/ms/micons/orange-dot.png');
                        }
                        else {
                            marker.setIcon('http://maps.google.com/mapfiles/ms/micons/red-dot.png');
                        }
                        
                        marker.metadata = {type: "point", id: numberArray[j]};
                        var infowindow = new google.maps.InfoWindow({});
                        marker.addListener('click', function() {
                            name = this.title;
                            banking_marker = this.banking_marker;
                            infowindow.setContent("");
                            $.getJSON("http://127.0.0.1:5000/dynamicData/" + this.station_number, null, function(data){
                                content = "";
                                available_bikes = data[0].available_bikes;
                                available_stands = data[0].available_bike_stands;
                                status = data[0].status;
                                if (status == "OPEN"){
                                    content += "<p class=name>" + name + "</p>";
                                } else {
                                    content += "<p class=name>" + name + "</p>";
                                }
        

                                // content += "<p style=color:green> Status: " + status + "</p>"
                                content += "<div id=modal><div id=col1><span class=avail_bikes>" + available_bikes.toString() + " </span>";
                                content += "<p id=text>Available<br>Bikes</p></div>";
                                content += "<div id=col2><span class=avail_stands>" + available_stands.toString() + "</span>";
                                content += "<p id=text>Free<br>Stands</p></div></div>";
                                
                                content += "<div id=imagediv><img src=https://salonproff.ie/wp-content/uploads/2017/05/visa-logo-png-image-4.png>"
                                content += "<img src='/static/mastercard.png'>";
                                if (banking_marker == "True"){
                                content += "<img src='/static/banking.png'>";
                                } else if (banking_marker == "False") {
                                    content += "<img src='/static/nobanking.png'>";
                                }
                                // content += "<p>Banking" + banking + "</p>";
                                infowindow.setContent(content);
                            })
                            infowindow.open(map, this);
                            dailyGraph(this.station_number, name);
                            hourlyGraph(this.station_number, name);
                        });
        
                    }
                    //console.log(bankingArray)                     
                }
            }
            xmlhttp.open("GET", url, true);
            xmlhttp.send();

            
            var map = new google.maps.Map(document.getElementById('map'), options);
            
        }
         
        </script>

<!-------------------------- Dropdown Menu ------------------------------------------->
        <script>
            var xmlhttp1 = new XMLHttpRequest();
            var url1 = "http://127.0.0.1:5000/stations";
            var dropdownName = [];
            var dropdownValue = [];
            var defaultValue = "Select Station";
            xmlhttp1.onreadystatechange = function () {
                if (xmlhttp1.readyState == 4 && xmlhttp1.status == 200) {
                    dropdownData = JSON.parse(xmlhttp1.responseText);
                    for (var j = 0; j < dropdownData.length; j++) {
                        dropdownName.push(dropdownData[j].name)
                        dropdownValue.push(dropdownData[j].number)
                    }
                }
            dropDownMenu = "<option selected disabled value=" + defaultValue + ">" + defaultValue + "</option>";
            for (var i = 0; i < dropdownName.length; i++){
            dropDownMenu += "<option value=" + dropdownValue[i] + ">" +  dropdownName[i]  + "</option>";
                }
                document.getElementById("stations").innerHTML = dropDownMenu;
            }
            xmlhttp1.open("GET", url1, true);
            xmlhttp1.send();
            
        </script>

<!--------------------------- DropDown Display ----------------------------------------->

        <script>
            var sel = document.getElementById("stations");
            sel.addEventListener("change", myFunction);

            function myFunction() {
                var bikeInfo = document.getElementById("nearestInfo");
                bikeInfo.innerHTML = "";
                value = sel.value;
                selectStation = $( "#stations option:selected" ).text();
                dailyGraph(value, selectStation);
                hourlyGraph(value, selectStation);
                $.getJSON("http://127.0.0.1:5000/dynamicData/" + value, null, function(info){
                    available_bikes = info[0].available_bikes;
                    available_stands = info[0].available_bike_stands;
                    status = info[0].status;
                    bikeInfo.innerHTML += "<p> Status: " + status + "</p><p> Available Bikes: " + available_bikes.toString() + " </p><p> Available Stands: " + available_stands.toString() + "</p>"
                    })
            }
        </script>

<!-------------------------- Current Weather ------------------------------------------->
        <script>
            var weather;
            var weatherDisplay = "";

            $.getJSON("/weather", null, function(weather){

                var today = new Date();
                var time = today.getHours() + ":" + today.getMinutes();  
                console.log(time);
                
                weatherDisplay += "<p>" + weather[0].date + ' ' + time + "</p>"

                // iconList = ['rain', 'partly-cloudy-day', 'cloudy','wind','partly-cloudy-night',
                // 'clear-night','clear-day'];

                var iconDict =  [{ 
                    icon: 'rain',
                    image: "<img div id='iconIMG' src='/static/images/rain.png'"
                },
                {
                    icon: 'partly-cloudy-day',
                    image: "<img div id='iconIMG' src='/static/images/partcloudy.png'>"
                },
                {
                    icon: 'cloudy',
                    image: "<img div id='iconIMG' src='/static/images/cloud.png'>"
                },
                {
                    icon: 'wind',
                    image: "<img div id='iconIMG' src='/static/images/wind.png'"
                },
                {
                    icon: 'partly-cloudy-night',
                    image: "<img div id='iconIMG' src='/static/images/cloudynight.png'>"
                },
                {
                    icon: 'clear-night',
                    image: "<img div id='iconIMG' src='/static/images/clearnight.png'"
                },
                {
                    icon: 'clear-day',
                    image: "<img div id='iconIMG' src='/static/images/clearday.png'"
                }
                ];                                                

                for (var c = 0; c < iconDict.length; c ++){
                    console.log(iconDict[c].icon);
                    if (iconDict[c].icon == weather[0].icon){
                        console.log("HIT");
                        
                        weatherDisplay += iconDict[c].image;                    
                    }
                }
                weatherDisplay += "<p> Status: " + weather[0].status + "</p>"
                weatherDisplay += "<p> Icon: " + weather[0].icon + "</p>"
                weatherDisplay += "<p> Rain Probability: " + weather[0].rainProb + "</p>"
                weatherDisplay += "<p>Rain Intensity: " + weather[0].rainIntensity + "</p>"
                // weatherDisplay += "<p>Rain Type: " + weather[0].rainType + "</p>"
                weatherDisplay += "<p>Temperature: " + weather[0].temp + "</p>"
                weatherDisplay += "<p>Wind Speed: " + weather[0].windSpeed + "</p>"
                document.getElementById("weatherInfo").innerHTML = weatherDisplay;

            })
            
        </script>
        <script>
        var currentLocation = [];

        function success(pos) {
            crd = pos.coords;
            console.log(pos.coords);
            currentLocation.push({
                lat: pos.coords.latitude,
                long: pos.coords.longitude
            });
        }
        
        navigator.geolocation.getCurrentPosition(success);

    </script>

<!-------------------------- GeoLocation ------------------------------------------->

    <script>
        var long = [];
        var lat = [];
        var dict = [];
        var distanceArray = [];


        function coordinates() {
            var xmlhttp1 = new XMLHttpRequest();
            var url = "http://127.0.0.1:5000/stations";
            xmlhttp1.onreadystatechange = function () {
                if (xmlhttp1.readyState == 4 && xmlhttp1.status == 200) {
                    coorddata = JSON.parse(xmlhttp1.responseText);
                    for (var j = 0; j < coorddata.length; j++) {
                        key = coorddata[j].name,
                            latitude = coorddata[j].latitude,
                            longitude = coorddata[j].longitude,
                            currentLat = currentLocation[0].lat,
                            currentLong = currentLocation[0].long

                        distance = Math.sqrt((Math.pow((currentLong - coorddata[j].longitude), 2)) + (Math.pow((
                             currentLat - coorddata[j].latitude), 2)));

                        distanceArray.push({
                            name: key,
                            dist: distance
                        });

                    }
                    var newDist;

                    distance1 = Math.sqrt((Math.pow((currentLong - coorddata[0].longitude), 2)) + (Math.pow((
                        currentLat - coorddata[0].latitude), 2)));

                    for (var r = 0; r < coorddata.length; r++) {
                        distance2 = Math.sqrt((Math.pow((currentLong - coorddata[r].longitude), 2)) + (Math.pow((
                            currentLat - coorddata[r].latitude), 2)));
                         if (distance2 < distance1) {
                            var newDist = distance2
                            var distance1 = distance2
                            var name = coorddata[r].name
                        }
                    }
                        nearest = "<p>Nearest Station is " + name +"</p>";
                        nearest += "<p> It is " + newDist + " away.</p>";
                    
                    document.getElementById("nearestInfo").innerHTML = nearest; 

                }

            }

            xmlhttp1.open("GET", url, true);
            xmlhttp1.send();
        }
        coordinates();
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSEIwAGX4ZvK2nEsFYMf1xjalFmwQcGCM&callback=initMap">
    </script>
    </body>

</html>